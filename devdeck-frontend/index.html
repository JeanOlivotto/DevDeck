<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DevDeck Kanban</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Gerais (mantidos e alguns adicionados/ajustados) */
        body { font-family: 'Inter', sans-serif; background-color: #181c2f; color: #e0e6ff; }
        .auth-container { background-color: #23284a; box-shadow: 0 4px 32px rgba(0, 0, 0, 0.4); }
        .auth-input { background-color: #1e223b; border: 1px solid #3a416f; color: #e0e6ff; }
        .auth-button { background-image: linear-gradient(to right, #00eaff, #a259ff); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 234, 255, 0.2); }
        .auth-button:hover { background-image: linear-gradient(to right, #a259ff, #00eaff); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(162, 89, 255, 0.3); }
        .link-style { color: #00eaff; cursor: pointer; }
        .link-style:hover { text-decoration: underline; color: #a259ff; }
        /* ... (mantém estilos de .task-placeholder, .dragging, .modal, .modal-content, etc.) ... */
        .task-placeholder { background-color: rgba(67, 76, 125, 0.5); border: 2px dashed #a259ff; border-radius: 0.5rem; min-height: 60px; margin-bottom: 0.75rem; }
        .dragging { opacity: 0.6; transform: rotate(2deg); cursor: grabbing; }
        .modal { background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { background-color: #23284a; box-shadow: 0 4px 32px rgba(0, 0, 0, 0.4); }
        .modal-input, .modal-textarea, .modal-select { background-color: #1e223b; border: 1px solid #3a416f; color: #e0e6ff; }
        .modal-button { background-image: linear-gradient(to right, #00eaff, #a259ff); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 234, 255, 0.2); }
        .modal-button:hover { background-image: linear-gradient(to right, #a259ff, #00eaff); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(162, 89, 255, 0.3); }
        .modal-close-button { background-color: #4a517e; transition: background-color 0.3s ease; }
        .modal-close-button:hover { background-color: #6a719e; }
        .column-header { background-image: linear-gradient(to right, #00eaff, #a259ff, #ff2d92); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 8px rgba(162, 89, 255, 0.3); letter-spacing: 1px; }
        .task-card { background: linear-gradient(135deg, #23284a 0%, #2e335a 100%); border-left: 4px solid #a259ff; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; cursor: grab; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(162, 89, 255, 0.35); }
        .add-task-button { background-image: linear-gradient(to right, #00eaff, #a259ff); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 234, 255, 0.2); }
        .add-task-button:hover { background-image: linear-gradient(to right, #a259ff, #00eaff); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(162, 89, 255, 0.3); }
        .board-selector-container { display: flex; align-items: center; overflow-x: auto; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid #3a416f; }
        .board-button { padding: 0.5rem 1rem; margin-right: 0.75rem; cursor: pointer; border: 1px solid transparent; border-radius: 0.375rem; transition: all 0.2s ease; font-weight: 500; color: #a0aec0; background-color: transparent; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; }
        .board-button:hover { background-color: rgba(162, 89, 255, 0.1); color: #e0e6ff; }
        .board-button.active-board { color: #00eaff; background-color: rgba(0, 234, 255, 0.1); border-color: #00eaff; font-weight: 600; }
        .board-action-icon { opacity: 0.5; transition: opacity 0.2s ease; width: 1em; height: 1em; display: inline-block; cursor: pointer; }
        .board-button:hover .board-action-icon, .board-action-icon:hover { opacity: 1; }
        .rename-icon:hover { color: #a259ff; } .delete-icon { color: #f56565; } .delete-icon:hover { color: #c53030; }
        #add-board-button { margin-left: auto; flex-shrink: 0; }
        .board-selector-container::-webkit-scrollbar { height: 8px; } .board-selector-container::-webkit-scrollbar-track { background: #1e223b; border-radius: 4px;} .board-selector-container::-webkit-scrollbar-thumb { background: #3a416f; border-radius: 4px;} .board-selector-container::-webkit-scrollbar-thumb:hover { background: #4a517e; }

    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center"> <header class="w-full max-w-7xl flex items-center justify-between mb-6 sm:mb-10 px-4">
         <div class="flex items-center">
             <img src="./img/logo-DevDesck-removebg-preview.png" alt="DevDeck Logo" class="w-10 h-10 sm:w-12 sm:h-12 mr-3 filter drop-shadow-[0_0_8px_rgba(162,89,255,0.7)]"/>
            <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 bg-clip-text text-transparent tracking-wide" style="text-shadow: 0 0 8px rgba(162, 89, 255, 0.4);">
                DevDeck
            </h1>
         </div>
         <button id="logout-button" class="modal-close-button text-white font-semibold py-2 px-4 rounded-lg hidden">
             Sair
         </button>
    </header>

    <div id="loading-indicator" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
        <p class="ml-4 text-xl text-purple-300">Carregando...</p>
    </div>

    <main id="app-container" class="container mx-auto max-w-7xl w-full hidden">
        <div id="boards-container" class="board-selector-container">
            <span class="text-gray-500 italic p-3">Carregando quadros...</span>
        </div>

        <section id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="column bg-[#23284a] rounded-xl shadow-lg p-4 flex flex-col" data-status="TODO">
                <h2 class="column-header text-xl font-semibold mb-4 text-center">To Do</h2>
                <div class="tasks flex-grow min-h-[100px] space-y-3" id="todo-tasks"></div>
                <button class="add-task-button text-white font-semibold py-2 px-4 rounded-lg mt-4 w-full" data-status="TODO">+ Nova Tarefa</button>
            </div>
            <div class="column bg-[#23284a] rounded-xl shadow-lg p-4 flex flex-col" data-status="DOING">
                <h2 class="column-header text-xl font-semibold mb-4 text-center">Doing</h2>
                <div class="tasks flex-grow min-h-[100px] space-y-3" id="doing-tasks"></div>
                 <button class="add-task-button text-white font-semibold py-2 px-4 rounded-lg mt-4 w-full" data-status="DOING">+ Nova Tarefa</button>
            </div>
            <div class="column bg-[#23284a] rounded-xl shadow-lg p-4 flex flex-col" data-status="DONE">
                <h2 class="column-header text-xl font-semibold mb-4 text-center">Done</h2>
                <div class="tasks flex-grow min-h-[100px] space-y-3" id="done-tasks"></div>
                 <button class="add-task-button text-white font-semibold py-2 px-4 rounded-lg mt-4 w-full" data-status="DONE">+ Nova Tarefa</button>
            </div>
        </section>
    </main>

    <div id="auth-section" class="w-full max-w-md mt-10"> <div id="login-view" class="auth-container p-8 rounded-lg">
            <h2 class="text-2xl font-semibold mb-6 text-center text-cyan-300">Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium mb-1">Email:</label>
                    <input type="email" id="login-email" class="auth-input w-full p-2 rounded" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium mb-1">Senha:</label>
                    <input type="password" id="login-password" class="auth-input w-full p-2 rounded" required>
                </div>
                <p id="login-error" class="text-red-400 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="auth-button w-full text-white font-semibold py-2 px-4 rounded-lg">
                    Entrar
                </button>
            </form>
            <p class="mt-6 text-center text-sm">
                Não tem uma conta? <span id="show-signup" class="link-style">Cadastre-se</span>
            </p>
        </div>

        <div id="signup-view" class="auth-container p-8 rounded-lg hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center text-cyan-300">Cadastro</h2>
            <form id="signup-form">
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium mb-1">Email:</label>
                    <input type="email" id="signup-email" class="auth-input w-full p-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label for="signup-password" class="block text-sm font-medium mb-1">Senha:</label>
                    <input type="password" id="signup-password" class="auth-input w-full p-2 rounded" required minlength="6">
                     <small class="text-gray-400">Mínimo de 6 caracteres.</small>
                </div>
                 <div class="mb-6">
                    <label for="signup-confirm-password" class="block text-sm font-medium mb-1">Confirmar Senha:</label>
                    <input type="password" id="signup-confirm-password" class="auth-input w-full p-2 rounded" required minlength="6">
                </div>
                <p id="signup-error" class="text-red-400 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="auth-button w-full text-white font-semibold py-2 px-4 rounded-lg">
                    Cadastrar
                </button>
            </form>
            <p class="mt-6 text-center text-sm">
                Já tem uma conta? <span id="show-login" class="link-style">Faça login</span>
            </p>
        </div>

    </div>

    <div id="task-modal" class="modal fixed inset-0 flex items-center justify-center z-40 hidden">...</div>
    <div id="board-modal" class="modal fixed inset-0 flex items-center justify-center z-40 hidden">...</div>

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">...</svg>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const TOKEN_KEY = 'devdeck_auth_token'; // Chave para guardar token no localStorage

        // Elementos DOM (adicionar elementos de Auth)
        const loadingIndicator = document.getElementById('loading-indicator');
        const appContainer = document.getElementById('app-container');
        const authSection = document.getElementById('auth-section');
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const showSignupLink = document.getElementById('show-signup');
        const showLoginLink = document.getElementById('show-login');
        const logoutButton = document.getElementById('logout-button');

        // Elementos do Kanban (mantidos)
        const boardsContainer = document.getElementById('boards-container');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const taskIdInput = document.getElementById('task-id');
        const taskTitleInput = document.getElementById('task-title');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskStatusSelect = document.getElementById('task-status');
        const modalCancelButton = document.getElementById('modal-cancel');
        const modalSaveButton = document.getElementById('modal-save');
        const modalDeleteButton = document.getElementById('modal-delete');
        const boardModal = document.getElementById('board-modal');
        const boardModalTitle = document.getElementById('board-modal-title');
        const boardForm = document.getElementById('board-form');
        const boardIdInput = document.getElementById('board-id');
        const boardNameInput = document.getElementById('board-name');
        const boardError = document.getElementById('board-error');
        const boardModalCancelButton = document.getElementById('board-modal-cancel');
        const boardModalSaveButton = document.getElementById('board-modal-save');


        let currentBoardId = null;
        let allBoards = [];
        let draggedTaskElement = null;
        let authToken = localStorage.getItem(TOKEN_KEY); // Guarda o token JWT

        // --- Funções da API (Modificada fetchApi, novas auth) ---
        async function fetchApi(endpoint, options = {}, isAuth = false) { // Adicionado isAuth flag
            loadingIndicator.classList.remove('hidden');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            // Adiciona token se necessário e disponível
            if (!isAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers, // Usa os headers montados
                });

                if (!response.ok) {
                    // Se erro 401 (Não Autorizado), força logout
                    if (response.status === 401 && !isAuth) {
                        console.warn('Token inválido ou expirado. Fazendo logout.');
                        logout();
                        throw new Error('Sessão inválida ou expirada. Faça login novamente.');
                    }

                    const errorData = await response.json();
                    console.error('API Error:', response.status, errorData);
                    let specificMessage = 'Erro desconhecido';
                    if (errorData && typeof errorData === 'object') {
                        if (Array.isArray(errorData.message)) { specificMessage = errorData.message.join(', '); }
                        else if (errorData.message) { specificMessage = errorData.message; }
                        else if (errorData.error) { specificMessage = errorData.error; }
                    } else if (typeof errorData === 'string') { specificMessage = errorData; }
                    throw new Error(specificMessage || `Erro na API: ${response.statusText}`);
                }

                if (response.status === 204) { return null; }
                return await response.json();
            } catch (error) {
                console.error('Erro ao chamar API:', error);
                if (!isAuth && error.message.includes('Faça login novamente')) {
                   // Não mostra alert duplicado se já foi deslogado
                } else {
                  alert(`Erro: ${error.message}`); // Mostra erro genérico
                }
                throw error;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Funções de Autenticação
        async function signup(email, password) {
            return await fetchApi('/auth/signup', {
                method: 'POST',
                body: JSON.stringify({ email, password }),
            }, true); // isAuth = true
        }

        async function login(email, password) {
            const data = await fetchApi('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password }),
            }, true); // isAuth = true
            if (data && data.access_token) {
                authToken = data.access_token;
                localStorage.setItem(TOKEN_KEY, authToken); // Salva no localStorage
            }
            return data;
        }

        function logout() {
            authToken = null;
            localStorage.removeItem(TOKEN_KEY); // Remove do localStorage
            showLoginView(); // Mostra tela de login
            // Limpa dados da aplicação (opcional, mas recomendado)
            currentBoardId = null;
            allBoards = [];
            boardsContainer.innerHTML = ''; // Limpa botões de quadros
            document.querySelectorAll('.tasks').forEach(col => col.innerHTML = ''); // Limpa colunas de tarefas
        }


        // Funções CRUD (usam fetchApi modificado)
        async function getBoards() { return await fetchApi('/boards'); }
        async function createBoard(name) { /* ... (código mantido, usa fetchApi) ... */ }
        async function getTasks(boardId) { if (!boardId) return []; return await fetchApi(`/tasks?boardId=${boardId}`); }
        async function createTask(taskData) { return await fetchApi('/tasks', { method: 'POST', body: JSON.stringify(taskData) }); }
        async function updateTask(taskId, taskData) { return await fetchApi(`/tasks/${taskId}`, { method: 'PATCH', body: JSON.stringify(taskData) }); }
        async function deleteTask(taskId) { return await fetchApi(`/tasks/${taskId}`, { method: 'DELETE' }); }
        async function updateBoard(boardId, boardData) { /* ... (código mantido, usa fetchApi) ... */ }
        async function deleteBoard(boardId) { return await fetchApi(`/boards/${boardId}`, { method: 'DELETE' }); }

        // --- Controle de Views ---
        function showLoginView() {
            appContainer.classList.add('hidden');
            authSection.classList.remove('hidden');
            loginView.classList.remove('hidden');
            signupView.classList.add('hidden');
            logoutButton.classList.add('hidden');
            loginError.classList.add('hidden'); // Esconde erros ao trocar de view
            signupError.classList.add('hidden');
        }

        function showSignupView() {
            appContainer.classList.add('hidden');
            authSection.classList.remove('hidden');
            loginView.classList.add('hidden');
            signupView.classList.remove('hidden');
            logoutButton.classList.add('hidden');
            loginError.classList.add('hidden');
            signupError.classList.add('hidden');
        }

        function showKanbanView() {
            authSection.classList.add('hidden');
            appContainer.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
            loadInitialData(); // Carrega os dados do Kanban
        }

        // --- Funções de Renderização Kanban (sem alterações internas) ---
        function renderBoardSelectors(boards) { /* ... (código mantido) ... */ }
        function setActiveBoardUI(selectedBoardId) { /* ... (código mantido) ... */ }
        function renderTasks(tasks) { /* ... (código mantido) ... */ }
        function createTaskElement(task) { /* ... (código mantido) ... */ }

        // --- Funções do Modal Tarefa (sem alterações internas) ---
        function openTaskModal(task = null) { /* ... (código mantido) ... */ }
        function closeTaskModal() { /* ... (código mantido) ... */ }
        async function handleTaskFormSubmit(event) { /* ... (código mantido) ... */ }
        async function handleDeleteTask() { /* ... (código mantido) ... */ }

        // --- Funções do Modal Quadro (sem alterações internas) ---
        function openBoardModal(boardToEdit = null) { /* ... (código mantido) ... */ }
        function closeBoardModal() { /* ... (código mantido) ... */ }
        async function handleBoardFormSubmit(event) { /* ... (código mantido) ... */ }
        async function handleDeleteBoard(boardId, boardName) { /* ... (código mantido) ... */ }

        // --- Drag and Drop (sem alterações internas) ---
        function handleDragStart(event) { /* ... (código mantido) ... */ }
        function handleDragEnd(event) { /* ... (código mantido) ... */ }
        function handleDragOver(event) { /* ... (código mantido) ... */ }
        function getDragAfterElement(container, y) { /* ... (código mantido) ... */ }
        function handleDragEnter(event) { /* ... (código mantido) ... */ }
        function handleDragLeave(event) { /* ... (código mantido) ... */ }
        async function handleDrop(event) { /* ... (código mantido) ... */ }
        function setupDragAndDrop() { /* ... (código mantido) ... */ }

        // --- Inicialização Kanban e Seleção de Quadro ---
        async function loadTasksForBoard(boardId) { /* ... (código mantido) ... */ }
        function handleBoardSelection(boardId) { /* ... (código mantido) ... */ }
        async function loadInitialData(selectBoardId = null) {
             // Só executa se estiver autenticado
             if (!authToken) {
                 console.warn("Tentando carregar dados do Kanban sem autenticação.");
                 logout(); // Garante que está na tela de login
                 return;
             }
             try {
                allBoards = await getBoards(); renderBoardSelectors(allBoards); let initialBoardId = selectBoardId;
                if (!initialBoardId) {
                    const defaultBoardNamesOrder = ["Tasks Pendentes", "Novas Ideias", "Alinhamento com Cliente"]; let foundDefault = false;
                    for (const name of defaultBoardNamesOrder) { const board = allBoards.find(b => b.name === name); if (board) { initialBoardId = board.id; foundDefault = true; break; } }
                    if (!foundDefault && allBoards.length > 0) { initialBoardId = allBoards[0].id; } else if (allBoards.length === 0) { initialBoardId = null; }
                }
                if (initialBoardId) { handleBoardSelection(initialBoardId); } else { currentBoardId = null; setActiveBoardUI(null); renderTasks([]); console.log("Nenhum quadro encontrado para este usuário."); }
            } catch (error) {
                // Erro já tratado em fetchApi (incluindo deslogar se for 401)
                console.error('Erro ao carregar dados iniciais do Kanban:', error);
                // Não precisa renderizar erro aqui se fetchApi já deslogou
                if (authToken) { // Só mostra erro se ainda estiver "logado"
                   boardsContainer.innerHTML = '<span class="text-red-500 p-3">Erro ao carregar quadros</span>'; renderTasks([]);
                }
            }
         }

        // --- Event Listeners ---

        // Navegação Auth
        showSignupLink.addEventListener('click', showSignupView);
        showLoginLink.addEventListener('click', showLoginView);
        logoutButton.addEventListener('click', logout);

        // Formulário Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await login(email, password);
                showKanbanView(); // Mostra o Kanban após login bem-sucedido
            } catch (error) {
                loginError.textContent = error.message || 'Erro ao fazer login.';
                loginError.classList.remove('hidden');
            }
        });

        // Formulário Signup
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            signupError.classList.add('hidden');
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;

            if (password !== confirmPassword) {
                signupError.textContent = 'As senhas não coincidem.';
                signupError.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                 signupError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                 signupError.classList.remove('hidden');
                 return;
            }

            try {
                await signup(email, password);
                alert('Cadastro realizado com sucesso! Faça o login.'); // Mensagem simples
                showLoginView(); // Redireciona para login após cadastro
            } catch (error) {
                signupError.textContent = error.message || 'Erro ao cadastrar.';
                signupError.classList.remove('hidden');
            }
        });


        // Listeners Kanban (mantidos)
        document.querySelectorAll('.add-task-button').forEach(button => { button.addEventListener('click', (event) => { if (!currentBoardId) { alert("Selecione ou crie um quadro."); return; } openTaskModal(); const defaultStatus = event.target.dataset.status || 'TODO'; taskStatusSelect.value = defaultStatus; }); });
        taskForm.addEventListener('submit', handleTaskFormSubmit); modalCancelButton.addEventListener('click', closeTaskModal); modalDeleteButton.addEventListener('click', handleDeleteTask);
        boardForm.addEventListener('submit', handleBoardFormSubmit); boardModalCancelButton.addEventListener('click', closeBoardModal);


        // --- Inicialização Geral ---
        document.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem(TOKEN_KEY); // Pega token ao carregar
            if (authToken) {
                showKanbanView(); // Tenta mostrar Kanban se tiver token
            } else {
                showLoginView(); // Mostra login se não tiver token
            }
        });

    </script>

</body>
</html>